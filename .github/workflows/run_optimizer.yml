name: Run Warehouse Route Optimizer

on:
  schedule:
    - cron: '30 17 * * *'  # Runs every day at 11:00 PM IST (17:30 UTC)
  workflow_dispatch:

jobs:
  run-optimizer:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client ortools

    - name: Decode and create service account key file
      shell: bash
      run: |
        echo "${{ secrets.WAREHOUSE_GDRIVE_KEY }}" | base64 -d > service_account.json
        echo "‚úÖ service_account.json created."
        head -c 80 service_account.json || true  # sanity check preview

    - name: Run Warehouse Route Optimizer
      run: |
        python warehouse_route_optimizer.py

    - name: Verify JSON output
      run: |
        echo "üìÑ Checking JSON output..."
        if [ -f warehouse_route_summary.json ]; then
          cat warehouse_route_summary.json
        else
          echo "‚ö†Ô∏è No output file found!"
          exit 1
        fi

    - name: Update JSON on Google Drive (safeguard sync)
      env:
        GOOGLE_APPLICATION_CREDENTIALS: service_account.json
      run: |
        python - <<'EOF'
        from google.oauth2.service_account import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        import json

        creds = Credentials.from_service_account_file(
            "service_account.json",
            scopes=["https://www.googleapis.com/auth/drive"]
        )
        service = build("drive", "v3", credentials=creds)

        file_path = "warehouse_route_summary.json"
        file_id = "1oaq5MPXTa73FpdxZihQfrLVSeRtyMtFq"  # ‚úÖ matches Python script

        try:
            # Validate JSON
            with open(file_path, "r") as f:
                json.load(f)

            media = MediaFileUpload(file_path, mimetype="application/json", resumable=True)
            updated = service.files().update(fileId=file_id, media_body=media).execute()
            print("‚úÖ File updated successfully on Drive:", updated.get("id"))
        except json.JSONDecodeError:
            print("‚ùå Invalid JSON ‚Äî skipping upload.")
        except Exception as e:
            print("‚ùå Drive update safeguard failed:", e)
        EOF
